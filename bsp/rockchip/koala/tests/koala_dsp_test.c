/**
  * Copyright (c) 2019 Fuzhou Rockchip Electronics Co., Ltd
  *
  * SPDX-License-Identifier: Apache-2.0
  ******************************************************************************
  * @file    koala_dsp_test.c
  * @author  He Hua
  * @version V0.1
  * @date    20-Mar-2019
  * @brief   dsp test for koala to sbc datas
  *
  ******************************************************************************
  */

#include <rtdevice.h>
#include <rtthread.h>

#if defined(RT_DSP_DECODE_TEST)

#include "drv_dsp.h"
#include "dma.h"

#define WAKEUP_ID                     0x50000001
#define SBC_DECODER_CONFIG            0x60000001
#define SBC_DECODER_START             0x60000002

struct sbc_config_params
{
    /* input audio format */
    uint32_t audio_type;

    /* input buffer */
    uint32_t in_buffer;
    /*
     * in config cmd,this is the size of input buffer.
     * in decode/encode cmd, this is the real size of input stream/pcm,
     * and this size must less the size of input buffer in config cmd.
     */
    uint32_t in_size;

    /* output buffer */
    uint32_t out_buffer;

    /*
     * in config cmd,this is the size of output buffer.
     * in decode/encode cmd, this is the real size of output stream/pcm,
     * and this size must less the size of output buffer in config cmd.
     */
    uint32_t out_size;

    uint32_t out_format;
    uint32_t out_channels;
    uint32_t out_samplerate;
    uint32_t result;
};

typedef enum DSP_AUDIO_CODEC_TYPE
{
    DSP_AUDIO_CODEC_UNKNOW = 0,
    DSP_AUDIO_DECODE_SBC = 1,
    DSP_AUDIO_ENCODE_SBC = 2,
    DSP_AUDIO_CODEC_MAX,
} DSP_AUDIO_CODEC_TYPE;

// sbc datas for koala test
static char sbc_data[1024] =
{
    0x9C, 0xFD, 0x33, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x77, 0x6D, 0xB6,
    0xDD, 0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB, 0xB6, 0xDB, 0x6D, 0xDD, 0xB6, 0xDB, 0x76, 0xDB, 0x6D,
    0xBB, 0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7, 0x76, 0xDB, 0x6D, 0xDB, 0x6D, 0xB6, 0xEE, 0xDB, 0x6D,
    0xBB, 0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7, 0x6D, 0xB6, 0xDB, 0xBB, 0x6D, 0xB6, 0xED, 0xB6, 0xDB,
    0x77, 0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB, 0xB6, 0xDB, 0x6D, 0xDD, 0xB6, 0xDB,
    0x76, 0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7, 0x76, 0xDB, 0x6D, 0xDB, 0x6D, 0xB6,
    0xEE, 0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7, 0x6D, 0xB6, 0xDB, 0xBB, 0x6D, 0xB6,
    0xED, 0xB6, 0xDB, 0x9C, 0xFD, 0x33, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x77, 0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB, 0xB6, 0xDB, 0x6D, 0xDD, 0xB6, 0xDB,
    0x76, 0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7, 0x76, 0xDB, 0x6D, 0xDB, 0x6D, 0xB6,
    0xEE, 0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7, 0x6D, 0xB6, 0xDB, 0xBB, 0x6D, 0xB6,
    0xED, 0xB6, 0xDB, 0x77, 0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB, 0xB6, 0xDB, 0x6D,
    0xDD, 0xB6, 0xDB, 0x76, 0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7, 0x76, 0xDB, 0x6D,
    0xDB, 0x6D, 0xB6, 0xEE, 0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7, 0x6D, 0xB6, 0xDB,
    0xBB, 0x6D, 0xB6, 0xED, 0xB6, 0xDB, 0x9C, 0xFD, 0x33, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x77, 0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB, 0xB6, 0xDB, 0x6D,
    0xDD, 0xB6, 0xDB, 0x76, 0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7, 0x76, 0xDB, 0x6D,
    0xDB, 0x6D, 0xB6, 0xEE, 0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7, 0x6D, 0xB6, 0xDB,
    0xBB, 0x6D, 0xB6, 0xED, 0xB6, 0xDB, 0x77, 0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB,
    0xB6, 0xDB, 0x6D, 0xDD, 0xB6, 0xDB, 0x76, 0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7,
    0x76, 0xDB, 0x6D, 0xDB, 0x6D, 0xB6, 0xEE, 0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7,
    0x6D, 0xB6, 0xDB, 0xBB, 0x6D, 0xB6, 0xED, 0xB6, 0xDB, 0x9C, 0xFD, 0x33, 0x38, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x77, 0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB,
    0xB6, 0xDB, 0x6D, 0xDD, 0xB6, 0xDB, 0x76, 0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7,
    0x76, 0xDB, 0x6D, 0xDB, 0x6D, 0xB6, 0xEE, 0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7,
    0x6D, 0xB6, 0xDB, 0xBB, 0x6D, 0xB6, 0xED, 0xB6, 0xDB, 0x77, 0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E,
    0xED, 0xB6, 0xDB, 0xB6, 0xDB, 0x6D, 0xDD, 0xB6, 0xDB, 0x76, 0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E,
    0xDB, 0x6D, 0xB7, 0x76, 0xDB, 0x6D, 0xDB, 0x6D, 0xB6, 0xEE, 0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD,
    0xDB, 0x6D, 0xB7, 0x6D, 0xB6, 0xDB, 0xBB, 0x6D, 0xB6, 0xED, 0xB6, 0xDB, 0x9C, 0xFD, 0x33, 0x38,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x77, 0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E,
    0xED, 0xB6, 0xDB, 0xB6, 0xDB, 0x6D, 0xDD, 0xB6, 0xDB, 0x76, 0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E,
    0xDB, 0x6D, 0xB7, 0x76, 0xDB, 0x6D, 0xDB, 0x6D, 0xB6, 0xEE, 0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD,
    0xDB, 0x6D, 0xB7, 0x6D, 0xB6, 0xDB, 0xBB, 0x6D, 0xB6, 0xED, 0xB6, 0xDB, 0x77, 0x6D, 0xB6, 0xDD,
    0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB, 0xB6, 0xDB, 0x6D, 0xDD, 0xB6, 0xDB, 0x76, 0xDB, 0x6D, 0xBB,
    0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7, 0x76, 0xDB, 0x6D, 0xDB, 0x6D, 0xB6, 0xEE, 0xDB, 0x6D, 0xBB,
    0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7, 0x6D, 0xB6, 0xDB, 0xBB, 0x6D, 0xB6, 0xED, 0xB6, 0xDB, 0x9C,
    0xFD, 0x33, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x77, 0x6D, 0xB6, 0xDD,
    0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB, 0xB6, 0xDB, 0x6D, 0xDD, 0xB6, 0xDB, 0x76, 0xDB, 0x6D, 0xBB,
    0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7, 0x76, 0xDB, 0x6D, 0xDB, 0x6D, 0xB6, 0xEE, 0xDB, 0x6D, 0xBB,
    0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7, 0x6D, 0xB6, 0xDB, 0xBB, 0x6D, 0xB6, 0xED, 0xB6, 0xDB, 0x77,
    0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB, 0xB6, 0xDB, 0x6D, 0xDD, 0xB6, 0xDB, 0x76,
    0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7, 0x76, 0xDB, 0x6D, 0xDB, 0x6D, 0xB6, 0xEE,
    0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7, 0x6D, 0xB6, 0xDB, 0xBB, 0x6D, 0xB6, 0xED,
    0xB6, 0xDB, 0x9C, 0xFD, 0x33, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x77,
    0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB, 0xB6, 0xDB, 0x6D, 0xDD, 0xB6, 0xDB, 0x76,
    0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7, 0x76, 0xDB, 0x6D, 0xDB, 0x6D, 0xB6, 0xEE,
    0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7, 0x6D, 0xB6, 0xDB, 0xBB, 0x6D, 0xB6, 0xED,
    0xB6, 0xDB, 0x77, 0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB, 0xB6, 0xDB, 0x6D, 0xDD,
    0xB6, 0xDB, 0x76, 0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7, 0x76, 0xDB, 0x6D, 0xDB,
    0x6D, 0xB6, 0xEE, 0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7, 0x6D, 0xB6, 0xDB, 0xBB,
    0x6D, 0xB6, 0xED, 0xB6, 0xDB, 0x9C, 0xFD, 0x33, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x77, 0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB, 0xB6, 0xDB, 0x6D, 0xDD,
    0xB6, 0xDB, 0x76, 0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7, 0x76, 0xDB, 0x6D, 0xDB,
    0x6D, 0xB6, 0xEE, 0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7, 0x6D, 0xB6, 0xDB, 0xBB,
    0x6D, 0xB6, 0xED, 0xB6, 0xDB, 0x77, 0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB, 0xB6,
    0xDB, 0x6D, 0xDD, 0xB6, 0xDB, 0x76, 0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7, 0x76,
    0xDB, 0x6D, 0xDB, 0x6D, 0xB6, 0xEE, 0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7, 0x6D,
    0xB6, 0xDB, 0xBB, 0x6D, 0xB6, 0xED, 0xB6, 0xDB, 0x9C, 0xFD, 0x33, 0x38, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x77, 0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E, 0xED, 0xB6, 0xDB, 0xB6,
    0xDB, 0x6D, 0xDD, 0xB6, 0xDB, 0x76, 0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E, 0xDB, 0x6D, 0xB7, 0x76,
    0xDB, 0x6D, 0xDB, 0x6D, 0xB6, 0xEE, 0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD, 0xDB, 0x6D, 0xB7, 0x6D,
    0xB6, 0xDB, 0xBB, 0x6D, 0xB6, 0xED, 0xB6, 0xDB, 0x77, 0x6D, 0xB6, 0xDD, 0xB6, 0xDB, 0x6E, 0xED,
    0xB6, 0xDB, 0xB6, 0xDB, 0x6D, 0xDD, 0xB6, 0xDB, 0x76, 0xDB, 0x6D, 0xBB, 0xB6, 0xDB, 0x6E, 0xDB,
    0x6D, 0xB7, 0x76, 0xDB, 0x6D, 0xDB, 0x6D, 0xB6, 0xEE, 0xDB, 0x6D, 0xBB, 0x6D, 0xB6, 0xDD, 0xDB,
};

static struct dsp_work *dsp_create_work(uint32_t id,
                                        uint32_t algo_type,
                                        uint32_t param,
                                        uint32_t param_size)
{
    struct dsp_work *work;

    work = rk_dsp_work_create(RKDSP_ALGO_WORK);
    if (work)
    {
        work->id = id;
        work->algo_type = algo_type;
        work->param = param;
        work->param_size = param_size;
    }
    return work;
}

static void dsp_destory_work(struct dsp_work *work)
{
    rk_dsp_work_destroy(work);
}

static void dsp_sbc_decode(void *args)
{
    rt_kprintf("dsp_sbc_decode\n");

    rt_err_t ret;
    struct rt_device *dsp_dev;
    struct dsp_work *work;
    /* find dsp */
    dsp_dev = rt_device_find("dsp0");
    RT_ASSERT(dsp_dev != RT_NULL);
    /* open dsp */
    rt_device_open(dsp_dev, RT_DEVICE_OFLAG_RDWR);

    struct sbc_config_params *param = (struct sbc_config_params *)rt_dma_malloc(sizeof(struct sbc_config_params));
    /* create parameters of decoder */
    param->audio_type = DSP_AUDIO_DECODE_SBC;

    work = dsp_create_work(WAKEUP_ID, SBC_DECODER_CONFIG,
                           (uint32_t)param, sizeof(struct sbc_config_params));
    if (!work)
        rt_kprintf("dsp_sbc_decode dsp create config work fail\n");
    /* send config to dsp */
    ret = rt_device_control(dsp_dev, RKDSP_CTL_QUEUE_WORK, work);
    RT_ASSERT(!ret);
    /* wait config finish */
    ret = rt_device_control(dsp_dev, RKDSP_CTL_DEQUEUE_WORK, work);
    RT_ASSERT(!ret);
    rt_kprintf("dsp_sbc_decode in_buffer:0x%x, in_size:0x%x,out_buffer:0x%x, out_size:0x%x\n",
               param->in_buffer, param->in_size, param->out_buffer, param->out_size);

    dsp_destory_work(work);
    /* Start to work */
    work = dsp_create_work(WAKEUP_ID, SBC_DECODER_START, (uint32_t)param,
                           sizeof(struct sbc_config_params));
    if (!work)
        rt_kprintf("dsp create config work fail\n");

    int total = 1024;
    int offset = 0, left = total, size = 0;
    while (total > 0)
    {
        size = (left > 256) ? 256 : left;
        rt_memcpy((void *)param->in_buffer, (void *)(sbc_data + offset), size);
        param->in_size = size;
        offset += size;
        total -= size;
        /* send datas to dsp */
        ret = rt_device_control(dsp_dev, RKDSP_CTL_QUEUE_WORK, work);
        RT_ASSERT(!ret);
        /* get pcm datas and results from dsp */
        ret = rt_device_control(dsp_dev, RKDSP_CTL_DEQUEUE_WORK, work);
        RT_ASSERT(!ret);
        rt_kprintf("work result:0x%08x,outsize = %d\n", work->result, param->out_size);
    }

    dsp_destory_work(work);
    rt_dma_free(param);
    rt_device_close(dsp_dev);
    rt_kprintf("dsp dsp_sbc_decode out\n");
}

static void dsp_sbc_test(void)
{
    rt_thread_t thread;

    thread = rt_thread_create("dsp_sbc_decode",
                              dsp_sbc_decode, RT_NULL,
                              1024, 10, 20);
    if (thread != RT_NULL)
        rt_thread_startup(thread);
}

#ifdef RT_USING_FINSH
#include <finsh.h>
MSH_CMD_EXPORT(dsp_sbc_test, dsp_sbc_test test. e.g: dsp_sbc_test);
#endif

#endif
